name: release cutechess
on: [push, pull_request]

jobs:
    winrel:
        name: "${{ matrix.os }} Qt ${{ matrix.qt_version }}"
        runs-on: ${{ matrix.os }}
        env:
          VCDIR: 'C:\Program Files\Microsoft Visual Studio\2022\Enterprise'
          ISDIR: 'C:\Program Files (x86)\Inno Setup 6'
        strategy:
          matrix:
            qt_version: [5.15.2]
            os: [windows-latest]
        steps:
            - uses: actions/checkout@v3

            - name: install qt 5.x
              uses: jurplel/install-qt-action@v2
              if: startsWith(matrix.qt_version, '5.')
              with:
                version: ${{ matrix.qt_version }}
                aqtversion: '==2.1.*'

            - name: build cute chess
              run: |
                  mkdir build
                  cd build
                  cmake ..
                  cmake --build . --config release

            - name: set environment
              run: |
                chcp 65001 # set code page to utf-8
                $version = Get-Content -Path .version
                echo ("VERSION=" + $version) >> $env:GITHUB_ENV

            - name: create an installer
              run: |
                $env:ISDIR\iscc.exe" -DMyAppVersion="$env:VERSION" -DQtLibPath="$env:Qt5_Dir" -DMSVCPath="$env:VCDIR" -DCuteChessPath="." dist\windows_setup.iss
