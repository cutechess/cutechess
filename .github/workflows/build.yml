name: build cutechess
on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
    build:
        name: "${{ matrix.os }} Qt ${{ matrix.qt_version }}"
        runs-on: ${{ matrix.os }}
        strategy:
          matrix:
            qt_version: [5.15.2, 6.3.0]
            os: [windows-latest, ubuntu-latest, macos-latest]
        steps:
            - uses: actions/checkout@v3

            - name: install qt 5.x
              uses: jurplel/install-qt-action@v2
              if: startsWith(matrix.qt_version, '5.')
              with:
                version: ${{ matrix.qt_version }}
                aqtversion: '==2.1.*'

            - name: install qt 6.x
              uses: jurplel/install-qt-action@v2
              if: startsWith(matrix.qt_version, '6.')
              with:
                version: ${{ matrix.qt_version }}
                modules: 'qt5compat'
                aqtversion: '==2.1.*'

            - name: build cute chess
              if: matrix.os != 'windows-latest'
              run: |
                  qmake
                  make

            - name: run unit tests
              if: matrix.os != 'windows-latest'
              run: |
                  cd ${GITHUB_WORKSPACE}/projects/lib/tests/
                  qmake
                  make
                  make check

            - name: run unit tests (json)
              if: matrix.os != 'windows-latest'
              run: |
                  cd ${GITHUB_WORKSPACE}/projects/lib/components/json/tests/
                  qmake
                  make
                  make check

            - name: check manual pages
              if: matrix.os == 'ubuntu-latest'
              run: |
                  sudo apt install mandoc
                  cd ${GITHUB_WORKSPACE}/docs/
                  mandoc -T lint cutechess-cli.6
                  mandoc -T lint engines.json.5

            - name: build cute chess
              if: matrix.os == 'windows-latest'
              shell: cmd
              run: |
                  call "C:/Program Files/Microsoft Visual Studio/2022/Enterprise/VC/Auxiliary/Build/vcvars64.bat"
                  qmake
                  nmake /NOLOGO

            - name: run unit tests
              if: matrix.os == 'windows-latest'
              shell: cmd
              run: |
                  call "C:/Program Files/Microsoft Visual Studio/2022/Enterprise/VC/Auxiliary/Build/vcvars64.bat"
                  cd %GITHUB_WORKSPACE%\projects\lib\tests\
                  qmake
                  nmake /NOLOGO
                  nmake /NOLOGO check

            - name: run unit tests (json)
              shell: cmd
              if: matrix.os == 'windows-latest'
              run: |
                  call "C:/Program Files/Microsoft Visual Studio/2022/Enterprise/VC/Auxiliary/Build/vcvars64.bat"
                  cd %GITHUB_WORKSPACE%\projects\lib\components\json\tests\
                  qmake
                  nmake /NOLOGO
                  nmake /NOLOGO check
